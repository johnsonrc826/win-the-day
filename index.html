<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Win the Day</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .shell {
      width: 100%;
      max-width: 960px;
      background: #020617;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 1px solid #1f2937;
    }

    .app-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .app-title {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #facc15;
    }

    .app-subtitle {
      font-size: 0.95rem;
      color: #9ca3af;
      margin-top: 6px;
    }

    .date {
      text-align: center;
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .auth-card {
      max-width: 420px;
      margin: 12px auto 0;
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 16px 18px;
    }

    .auth-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 6px 8px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid #374151;
      cursor: pointer;
      background: #020617;
      color: #9ca3af;
    }

    .auth-tab.active {
      background: #facc15;
      border-color: #facc15;
      color: #111827;
      font-weight: 700;
    }

    .auth-label {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 6px;
      margin-bottom: 2px;
    }

    .auth-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    .auth-button {
      width: 100%;
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #facc15, #f97316);
      color: #111827;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
    }

    .auth-error {
      margin-top: 8px;
      font-size: 0.78rem;
      color: #fca5a5;
      min-height: 1.2em;
    }

    .auth-note {
      margin-top: 8px;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: center;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .user-email {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .logout-button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #9ca3af;
      font-size: 0.75rem;
      padding: 5px 10px;
      cursor: pointer;
    }

    .app-grid {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      grid-gap: 16px;
    }

    @media (max-width: 800px) {
      .app-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      margin-bottom: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .summary-card {
      background: radial-gradient(circle at top, #1f2937, #020617);
      border-color: #374151;
    }

    .summary-pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: 1px solid #4b5563;
    }

    .summary-pill.won {
      background: #22c55e22;
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .summary-pill.not-won {
      background: #ef444422;
      border-color: #ef4444;
      color: #fecaca;
    }

    .summary-body {
      font-size: 0.8rem;
      color: #d1d5db;
      margin-top: 4px;
    }

    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .goal-card {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
    }

    .goal-card.completed {
      border-color: #22c55e;
      background: #022c22;
    }

    .goal-checkbox {
      margin-top: 4px;
      width: 18px;
      height: 18px;
    }

    .goal-content {
      flex: 1;
    }

    .goal-label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .goal-description {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .goal-tag {
      display: inline-block;
      margin-top: 4px;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }

    .streak-row {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .streak-number {
      font-size: 1rem;
      font-weight: 600;
      color: #facc15;
    }

    .controls-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      cursor: pointer;
    }

    .btn-primary {
      flex: 1;
      padding: 7px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #facc15, #f97316);
      color: #111827;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .btn-secondary {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #9ca3af;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      flex: 0 0 auto;
    }

    .note {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 6px;
    }

    .tier-options {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .tier-pill {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 0.75rem;
      text-align: center;
      cursor: pointer;
      background: #020617;
      color: #9ca3af;
    }

    .tier-pill.active {
      background: #facc15;
      border-color: #facc15;
      color: #111827;
      font-weight: 700;
    }

    .tier-detail {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .token-summary {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.8rem;
    }

    .token-balance {
      font-size: 1rem;
      font-weight: 600;
      color: #a5b4fc;
    }

    .token-earned {
      color: #22c55e;
    }

    .small-label {
      font-size: 0.72rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .input-small {
      width: 100%;
      padding: 5px 8px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.78rem;
      margin-top: 2px;
    }

    .card-inner {
      margin-bottom: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #111827;
      background: #020617;
    }

    .leaderboard-list {
      margin-top: 6px;
      font-size: 0.75rem;
    }

    .leader-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #111827;
    }

    .leader-row.me {
      color: #facc15;
    }

    .leader-row:last-child {
      border-bottom: none;
    }

  </style>
</head>
<body>
  <div class="shell">
    <header class="app-header">
      <div class="app-title">WIN THE DAY</div>
      <div class="app-subtitle">Discipline • Efficiency • Competition</div>
      <div class="date" id="todayDate"></div>
    </header>

    <!-- AUTH SECTION -->
    <section id="authSection">
      <div class="auth-card">
        <div class="auth-tabs">
          <div class="auth-tab active" data-mode="login">Log In</div>
          <div class="auth-tab" data-mode="signup">Sign Up</div>
        </div>
        <div>
          <div class="auth-label">Email</div>
          <input type="email" id="authEmail" class="auth-input" placeholder="you@example.com" />
          <div class="auth-label">Password</div>
          <input type="password" id="authPassword" class="auth-input" placeholder="••••••••" />
        </div>
        <button class="auth-button" id="authSubmit">Log In</button>
        <div class="auth-error" id="authError"></div>
        <div class="auth-note">
          Your progress and rewards are stored securely with Supabase.
        </div>
      </div>
    </section>

    <!-- APP SECTION -->
    <section id="appSection" style="display:none;">
      <div class="top-bar">
        <div class="user-email" id="userEmail"></div>
        <button class="logout-button" id="logoutButton">Log Out</button>
      </div>

      <div class="app-grid">
        <!-- LEFT: goals -->
        <div>
          <div class="card summary-card">
            <div class="card-header">
              <div>
                <div class="card-title" id="summaryTitle">You haven't won the day yet.</div>
                <div class="card-subtitle" id="summarySubtitle"></div>
              </div>
              <div class="summary-pill not-won" id="summaryPill">In Progress</div>
            </div>
            <div class="summary-body" id="summaryBody"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Today's Goals</div>
              <div class="card-subtitle">Tap to complete and win the day.</div>
            </div>
            <div class="goals-list" id="goalsList"></div>
            <div class="controls-row">
              <button class="btn-primary" id="markAllDone">Mark All Done</button>
              <button class="btn-secondary" id="resetDay">Reset Today</button>
            </div>
            <div class="note">
              Your goals & streaks sync to your Supabase account. Use the same login anywhere.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Streaks</div>
              <div class="card-subtitle">Stack wins over time.</div>
            </div>
            <div class="streak-row">
              <div>
                Current Win Streak<br/>
                <span class="streak-number" id="currentStreak">0</span> days
              </div>
              <div style="text-align:right;">
                Longest Win Streak<br/>
                <span class="streak-number" id="longestStreak">0</span> days
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Customize Your 3 Goals</div>
              <div class="card-subtitle">Mind • Body • Wealth (or your own mix)</div>
            </div>
            <div id="goalSettings"></div>
            <div class="controls-row" style="margin-top:10px;">
              <button class="btn-primary" id="saveGoalSettings">Save Goals</button>
            </div>
          </div>
        </div>

        <!-- RIGHT: tiers, tokens, leaderboard -->
        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Subscription Tier (Simulated)</div>
              <div class="card-subtitle">Connect to Stripe later.</div>
            </div>
            <div class="tier-options" id="tierOptions">
              <div class="tier-pill" data-tier="free">Free</div>
              <div class="tier-pill" data-tier="pro">Pro</div>
              <div class="tier-pill" data-tier="elite">Elite</div>
            </div>
            <div class="tier-detail" id="tierDetail"></div>
            <div class="note">
              In production you’ll set tier from Stripe → Supabase. For now, pick manually.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Win Tokens & Rewards</div>
              <div class="card-subtitle">Earn tokens for discipline.</div>
            </div>
            <div class="token-summary">
              <div>
                Token Balance<br/>
                <span class="token-balance" id="tokenBalance">0</span>
              </div>
              <div style="text-align:right;">
                Earned Today<br/>
                <span class="token-earned" id="tokensEarnedToday">+0</span>
              </div>
            </div>
            <div class="small-label" style="margin-top:6px;">
              Earn rates (before multiplier):
            </div>
            <ul style="font-size:0.75rem; margin-left:16px; margin-top:3px; color:#9ca3af;">
              <li>Win the Day: +10 tokens</li>
              <li>Win the Week (5+ days): +50 tokens</li>
              <li>Win the Month (20+ days): +300 tokens</li>
            </ul>
            <div class="note">
              Multipliers – Free: 1x • Pro: 1.5x • Elite: 2x
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Discipline Leaderboard (Local Sample)</div>
              <div class="card-subtitle">Real leaderboard will use Supabase across users.</div>
            </div>
            <div class="leaderboard-list" id="leaderboardList"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------- SUPABASE INIT ----------
    const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co"; // TODO: replace
    const SUPABASE_ANON_KEY = "YOUR_ANON_PUBLIC_KEY_HERE";      // TODO: replace

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- CONFIG / CONSTANTS ----------
    const DEFAULT_GOALS = [
      {
        label: "5 minutes of Duolingo",
        description: "Intentional language practice.",
        tag: "Mind",
        sort_order: 0
      },
      {
        label: "100 pushups / 100 sit-ups / 100 squats",
        description: "Break it up however you want.",
        tag: "Body",
        sort_order: 1
      },
      {
        label: "Market research + check investment accounts",
        description: "Scan the markets & review your portfolio.",
        tag: "Wealth",
        sort_order: 2
      }
    ];

    const TIER_CONFIG = {
      free: {
        label: "Free",
        multiplier: 1,
        description: "Start building discipline. Earn tokens at 1x rate."
      },
      pro: {
        label: "Pro",
        multiplier: 1.5,
        description: "Earn 1.5x tokens, geared for weekly/monthly challenges."
      },
      elite: {
        label: "Elite",
        multiplier: 2,
        description: "Earn 2x tokens, built for year-long discipline."
      }
    };

    const todayKey = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    };

    // ---------- DOM ELEMENTS ----------
    const authSection = document.getElementById("authSection");
    const appSection = document.getElementById("appSection");
    const authTabs = document.querySelectorAll(".auth-tab");
    const authEmailInput = document.getElementById("authEmail");
    const authPasswordInput = document.getElementById("authPassword");
    const authSubmitButton = document.getElementById("authSubmit");
    const authErrorEl = document.getElementById("authError");
    const userEmailEl = document.getElementById("userEmail");
    const logoutButton = document.getElementById("logoutButton");

    const summaryTitleEl = document.getElementById("summaryTitle");
    const summarySubtitleEl = document.getElementById("summarySubtitle");
    const summaryPillEl = document.getElementById("summaryPill");
    const summaryBodyEl = document.getElementById("summaryBody");
    const goalsListEl = document.getElementById("goalsList");
    const currentStreakEl = document.getElementById("currentStreak");
    const longestStreakEl = document.getElementById("longestStreak");
    const goalSettingsEl = document.getElementById("goalSettings");
    const saveGoalSettingsBtn = document.getElementById("saveGoalSettings");
    const markAllDoneBtn = document.getElementById("markAllDone");
    const resetDayBtn = document.getElementById("resetDay");
    const tierOptionsEl = document.getElementById("tierOptions");
    const tierDetailEl = document.getElementById("tierDetail");
    const tokenBalanceEl = document.getElementById("tokenBalance");
    const tokensEarnedTodayEl = document.getElementById("tokensEarnedToday");
    const leaderboardListEl = document.getElementById("leaderboardList");

    // ---------- APP STATE ----------
    let authMode = "login";
    let session = null;
    let profile = null; // row from profiles
    let goals = [];     // [{id,label,description,tag,sort_order,completed}]
    let dailyState = {
      date: todayKey(),
      completed_goal_ids: [],
      tokens_earned_today: 0
    };

    // ---------- UTIL ----------
    function formatDate(d) {
      return d.toLocaleDateString(undefined, {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    }

    function dayDiff(a, b) {
      const da = new Date(a);
      const db = new Date(b);
      return Math.round((db - da) / (1000 * 60 * 60 * 24));
    }

    function getTierMultiplier() {
      const tierKey = profile?.tier || "free";
      const t = TIER_CONFIG[tierKey] || TIER_CONFIG.free;
      return t.multiplier;
    }

    function allGoalsCompleted() {
      return goals.length > 0 && goals.every(g => g.completed);
    }

    // ---------- AUTH UI ----------
    function setAuthMode(mode) {
      authMode = mode;
      authTabs.forEach(tab => {
        const t = tab.getAttribute("data-mode");
        tab.classList.toggle("active", t === mode);
      });
      authSubmitButton.textContent = mode === "login" ? "Log In" : "Sign Up";
      authErrorEl.textContent = "";
    }

    authTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const mode = tab.getAttribute("data-mode");
        setAuthMode(mode);
      });
    });

    authSubmitButton.addEventListener("click", async () => {
      authErrorEl.textContent = "";
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value;
      if (!email || !password) {
        authErrorEl.textContent = "Email and password are required.";
        return;
      }
      try {
        if (authMode === "signup") {
          const { data, error } = await supabase.auth.signUp({
            email,
            password
          });
          if (error) throw error;
          // profile will be created on first load
        } else {
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
          });
          if (error) throw error;
        }
      } catch (e) {
        authErrorEl.textContent = e.message || "Authentication error.";
      }
    });

    logoutButton.addEventListener("click", async () => {
      await supabase.auth.signOut();
    });

    // ---------- DATA LOAD / SAVE WITH SUPABASE ----------

    async function ensureProfile(user) {
      const { data, error } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .maybeSingle();
      if (error) throw error;
      if (data) {
        profile = data;
        return;
      }
      // create profile
      const { data: inserted, error: insertError } = await supabase
        .from("profiles")
        .insert({
          id: user.id,
          email: user.email,
          tier: "free"
        })
        .select("*")
        .single();
      if (insertError) throw insertError;
      profile = inserted;

      // insert default goals
      const defaultRows = DEFAULT_GOALS.map(g => ({
        user_id: user.id,
        label: g.label,
        description: g.description,
        tag: g.tag,
        sort_order: g.sort_order
      }));
      await supabase.from("goals").insert(defaultRows);
    }

    async function loadGoals(user) {
      const { data, error } = await supabase
        .from("goals")
        .select("*")
        .eq("user_id", user.id)
        .order("sort_order", { ascending: true });
      if (error) throw error;

      let rows = data || [];
      if (rows.length === 0) {
        // just in case, reinsert defaults
        const defaultRows = DEFAULT_GOALS.map(g => ({
          user_id: user.id,
          label: g.label,
          description: g.description,
          tag: g.tag,
          sort_order: g.sort_order
        }));
        const { data: newRows, error: insertError } = await supabase
          .from("goals")
          .insert(defaultRows)
          .select("*");
        if (insertError) throw insertError;
        rows = newRows;
      }

      // attach completed flag from dailyState
      goals = rows.map(row => ({
        ...row,
        completed: dailyState.completed_goal_ids.includes(row.id)
      }));
    }

    async function loadDailyState(user) {
      const today = todayKey();
      const { data, error } = await supabase
        .from("daily_states")
        .select("*")
        .eq("user_id", user.id)
        .eq("date", today)
        .maybeSingle();
      if (error) throw error;
      if (data) {
        dailyState = {
          date: data.date,
          completed_goal_ids: data.completed_goal_ids || [],
          tokens_earned_today: data.tokens_earned_today || 0
        };
      } else {
        dailyState = {
          date: today,
          completed_goal_ids: [],
          tokens_earned_today: 0
        };
      }
    }

    async function saveProfile() {
      if (!session || !profile) return;
      const { error } = await supabase
        .from("profiles")
        .update({
          tier: profile.tier,
          tokens_balance: profile.tokens_balance,
          current_streak: profile.current_streak,
          longest_streak: profile.longest_streak,
          last_win_date: profile.last_win_date,
          total_days_won_this_week: profile.total_days_won_this_week,
          total_days_won_this_month: profile.total_days_won_this_month
        })
        .eq("id", session.user.id);
      if (error) console.error(error);
    }

    async function saveGoals() {
      if (!session) return;
      const userId = session.user.id;
      // Upsert the three goals
      const upserts = goals.map((g, idx) => ({
        id: g.id, // may be undefined for new goals; Supabase will generate
        user_id: userId,
        label: g.label,
        description: g.description,
        tag: g.tag,
        sort_order: idx
      }));
      const { error } = await supabase.from("goals").upsert(upserts);
      if (error) console.error(error);
    }

    async function saveDailyState() {
      if (!session) return;
      const userId = session.user.id;
      const { error } = await supabase
        .from("daily_states")
        .upsert({
          user_id: userId,
          date: dailyState.date,
          completed_goal_ids: dailyState.completed_goal_ids,
          tokens_earned_today: dailyState.tokens_earned_today
        });
      if (error) console.error(error);
    }

    // ---------- REWARD / STREAK LOGIC ----------

    function awardTokens(base) {
      const multiplier = getTierMultiplier();
      const earned = Math.round(base * multiplier);
      profile.tokens_balance = (profile.tokens_balance || 0) + earned;
      dailyState.tokens_earned_today =
        (dailyState.tokens_earned_today || 0) + earned;
    }

    async function processWinIfNeeded() {
      const today = todayKey();
      if (!profile) return;
      if (!allGoalsCompleted()) return;
      if (profile.last_win_date === today) return;

      // Daily win
      awardTokens(10);

      // Streaks
      const prev = profile.last_win_date;
      if (!prev) {
        profile.current_streak = 1;
      } else {
        const diff = dayDiff(prev, today);
        if (diff === 1) {
          profile.current_streak = (profile.current_streak || 0) + 1;
        } else {
          profile.current_streak = 1;
        }
      }
      profile.last_win_date = today;
      if (
        !profile.longest_streak ||
        profile.current_streak > profile.longest_streak
      ) {
        profile.longest_streak = profile.current_streak;
      }

      profile.total_days_won_this_week =
        (profile.total_days_won_this_week || 0) + 1;
      profile.total_days_won_this_month =
        (profile.total_days_won_this_month || 0) + 1;

      // Milestones
      if (profile.total_days_won_this_week === 5) {
        awardTokens(50);
      }
      if (profile.total_days_won_this_month === 20) {
        awardTokens(300);
      }

      await saveProfile();
      await saveDailyState();
      renderAll();
    }

    // ---------- RENDERING ----------

    function renderDate() {
      document.getElementById("todayDate").textContent = formatDate(new Date());
    }

    function renderUserInfo() {
      userEmailEl.textContent = session?.user?.email || "";
    }

    function renderSummary() {
      const completedCount = goals.filter(g => g.completed).length;
      const total = goals.length;
      if (completedCount === total && total > 0) {
        summaryTitleEl.textContent = "You won the day.";
        summarySubtitleEl.textContent = "All of your goals are complete.";
        summaryPillEl.textContent = "Won";
        summaryPillEl.classList.remove("not-won");
        summaryPillEl.classList.add("won");
        summaryBodyEl.textContent =
          "Lock this in and stack another day. Your discipline is compounding.";
      } else {
        summaryTitleEl.textContent = "You haven't won the day yet.";
        summarySubtitleEl.textContent = `You've completed ${completedCount} of ${total} goals. Stay locked in.`;
        summaryPillEl.textContent = "In Progress";
        summaryPillEl.classList.remove("won");
        summaryPillEl.classList.add("not-won");
        summaryBodyEl.textContent =
          "Complete all 3 to win the day, earn tokens, and climb your discipline leaderboard.";
      }
    }

    function renderGoals() {
      goalsListEl.innerHTML = "";
      goals.forEach(goal => {
        const card = document.createElement("div");
        card.className = "goal-card" + (goal.completed ? " completed" : "");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "goal-checkbox";
        checkbox.checked = goal.completed;
        checkbox.addEventListener("change", async () => {
          goal.completed = checkbox.checked;
          if (goal.completed) {
            if (!dailyState.completed_goal_ids.includes(goal.id)) {
              dailyState.completed_goal_ids.push(goal.id);
            }
          } else {
            dailyState.completed_goal_ids = dailyState.completed_goal_ids.filter(
              id => id !== goal.id
            );
          }
          await saveDailyState();
          renderSummary();
          if (allGoalsCompleted()) {
            await processWinIfNeeded();
          }
        });

        const content = document.createElement("div");
        content.className = "goal-content";

        const label = document.createElement("div");
        label.className = "goal-label";
        label.textContent = goal.label;

        const desc = document.createElement("div");
        desc.className = "goal-description";
        desc.textContent = goal.description || "";

        const tag = document.createElement("div");
        tag.className = "goal-tag";
        tag.textContent = goal.tag || "";

        content.appendChild(label);
        if (goal.description) content.appendChild(desc);
        if (goal.tag) content.appendChild(tag);

        card.appendChild(checkbox);
        card.appendChild(content);
        goalsListEl.appendChild(card);
      });
    }

    function renderStreaks() {
      currentStreakEl.textContent = profile?.current_streak || 0;
      longestStreakEl.textContent = profile?.longest_streak || 0;
    }

    function renderGoalSettings() {
      goalSettingsEl.innerHTML = "";
      goals.forEach((goal, idx) => {
        const inner = document.createElement("div");
        inner.className = "card-inner";

        const title = document.createElement("div");
        title.className = "card-title";
        title.style.fontSize = "0.85rem";
        title.textContent = `Goal ${idx + 1}`;

        const labelLabel = document.createElement("div");
        labelLabel.className = "small-label";
        labelLabel.textContent = "Title";

        const labelInput = document.createElement("input");
        labelInput.className = "input-small";
        labelInput.value = goal.label;

        const descLabel = document.createElement("div");
        descLabel.className = "small-label";
        descLabel.textContent = "Description (optional)";

        const descInput = document.createElement("input");
        descInput.className = "input-small";
        descInput.value = goal.description || "";

        const tagLabel = document.createElement("div");
        tagLabel.className = "small-label";
        tagLabel.textContent = "Category / Tag (Mind, Body, Wealth, etc.)";

        const tagInput = document.createElement("input");
        tagInput.className = "input-small";
        tagInput.value = goal.tag || "";

        inner._goalId = goal.id;
        inner._labelInput = labelInput;
        inner._descInput = descInput;
        inner._tagInput = tagInput;

        inner.appendChild(title);
        inner.appendChild(labelLabel);
        inner.appendChild(labelInput);
        inner.appendChild(descLabel);
        inner.appendChild(descInput);
        inner.appendChild(tagLabel);
        inner.appendChild(tagInput);

        goalSettingsEl.appendChild(inner);
      });
    }

    function renderTier() {
      const tierKey = profile?.tier || "free";
      const t = TIER_CONFIG[tierKey] || TIER_CONFIG.free;
      tierDetailEl.textContent =
        `${t.label} tier • Reward multiplier: ${t.multiplier}x. ${t.description}`;

      const pills = tierOptionsEl.querySelectorAll(".tier-pill");
      pills.forEach(p => {
        const tier = p.getAttribute("data-tier");
        p.classList.toggle("active", tier === tierKey);
      });
    }

    function renderTokens() {
      tokenBalanceEl.textContent = profile?.tokens_balance || 0;
      tokensEarnedTodayEl.textContent = "+" + (dailyState.tokens_earned_today || 0);
    }

    function renderLeaderboard() {
      leaderboardListEl.innerHTML = "";
      const myScore =
        (profile?.current_streak || 0) +
        (profile?.tokens_balance || 0) / 50;

      const demo = [
        { name: "Discipline Dave", score: 22.5 },
        { name: "Consistent Carla", score: 18 },
        { name: "Steady Sam", score: 12 },
        { name: "You", score: myScore }
      ].sort((a, b) => b.score - a.score);

      demo.forEach(u => {
        const row = document.createElement("div");
        row.className = "leader-row" + (u.name === "You" ? " me" : "");
        const left = document.createElement("div");
        left.textContent = u.name;
        const right = document.createElement("div");
        right.textContent = u.score.toFixed(1);
        row.appendChild(left);
        row.appendChild(right);
        leaderboardListEl.appendChild(row);
      });
    }

    function renderAll() {
      renderDate();
      renderUserInfo();
      renderSummary();
      renderGoals();
      renderStreaks();
      renderGoalSettings();
      renderTier();
      renderTokens();
      renderLeaderboard();
    }

    // ---------- UI EVENT HANDLERS ----------

    markAllDoneBtn.addEventListener("click", async () => {
      goals.forEach(g => (g.completed = true));
      dailyState.completed_goal_ids = goals.map(g => g.id);
      await saveDailyState();
      renderGoals();
      await processWinIfNeeded();
    });

    resetDayBtn.addEventListener("click", async () => {
      goals.forEach(g => (g.completed = false));
      dailyState.completed_goal_ids = [];
      dailyState.tokens_earned_today = 0;
      await saveDailyState();
      renderAll();
    });

    saveGoalSettingsBtn.addEventListener("click", async () => {
      const inners = goalSettingsEl.querySelectorAll(".card-inner");
      const newGoals = [];
      inners.forEach((inner, idx) => {
        const id = inner._goalId;
        const label = inner._labelInput.value.trim() || `Goal ${idx + 1}`;
        const description = inner._descInput.value.trim();
        const tag = inner._tagInput.value.trim();
        newGoals.push({
          id,
          label,
          description,
          tag,
          sort_order: idx,
          completed: false
        });
      });
      goals = newGoals;
      dailyState.completed_goal_ids = [];
      dailyState.tokens_earned_today = 0;
      await saveGoals();
      await saveDailyState();
      renderAll();
      alert("Goals updated.");
    });

    tierOptionsEl.addEventListener("click", async e => {
      const pill = e.target.closest(".tier-pill");
      if (!pill || !profile) return;
      const tier = pill.getAttribute("data-tier");
      profile.tier = tier;
      await saveProfile();
      renderTier();
      renderTokens();
    });

    // ---------- AUTH STATE ----------

    async function handleSessionChange(newSession) {
      session = newSession;
      if (!session) {
        // show auth UI
        authSection.style.display = "block";
        appSection.style.display = "none";
        profile = null;
        goals = [];
        dailyState = {
          date: todayKey(),
          completed_goal_ids: [],
          tokens_earned_today: 0
        };
        renderDate();
        return;
      }

      // logged in → load data
      authSection.style.display = "none";
      appSection.style.display = "block";
      authErrorEl.textContent = "";
      authEmailInput.value = "";
      authPasswordInput.value = "";

      try {
        await ensureProfile(session.user);
        await loadDailyState(session.user);
        await loadGoals(session.user);
      } catch (err) {
        console.error("Error loading data:", err);
      }
      renderAll();
    }

    // Initial load
    (async () => {
      const { data } = await supabase.auth.getSession();
      await handleSessionChange(data.session || null);
    })();

    supabase.auth.onAuthStateChange((_event, newSession) => {
      handleSessionChange(newSession);
    });

    // Initial date render
    renderDate();
  </script>
</body>
</html>
