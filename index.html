<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Win the Day</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: #020617;
      border-radius: 18px;
      padding: 20px 20px 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 1px solid #1f2937;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      grid-gap: 16px;
    }

    @media (max-width: 800px) {
      .app {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .app-header {
      grid-column: 1 / -1;
      text-align: center;
      margin-bottom: 10px;
    }

    .app-title {
      font-size: 1.7rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #facc15;
    }

    .app-subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-top: 6px;
    }

    .date {
      text-align: center;
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      margin-bottom: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .summary-card {
      background: radial-gradient(circle at top, #1f2937, #020617);
      border-color: #374151;
    }

    .summary-pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: 1px solid #4b5563;
    }

    .summary-pill.won {
      background: #22c55e22;
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .summary-pill.not-won {
      background: #ef444422;
      border-color: #ef4444;
      color: #fecaca;
    }

    .summary-body {
      font-size: 0.8rem;
      color: #d1d5db;
      margin-top: 4px;
    }

    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .goal-card {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
    }

    .goal-card.completed {
      border-color: #22c55e;
      background: #022c22;
    }

    .goal-checkbox {
      margin-top: 4px;
      width: 18px;
      height: 18px;
    }

    .goal-content {
      flex: 1;
    }

    .goal-label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .goal-description {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .goal-tag {
      display: inline-block;
      margin-top: 4px;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }

    .streak-row {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .streak-number {
      font-size: 1rem;
      font-weight: 600;
      color: #facc15;
    }

    .controls-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .btn-primary {
      flex: 1;
      padding: 7px 10px;
      background: linear-gradient(to right, #facc15, #f97316);
      color: #111827;
    }

    .btn-secondary {
      padding: 7px 10px;
      background: #020617;
      color: #9ca3af;
      border: 1px solid #374151;
      flex: 0 0 auto;
    }

    .note {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 6px;
    }

    .tier-options {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .tier-pill {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 0.75rem;
      text-align: center;
      cursor: pointer;
      background: #020617;
      color: #9ca3af;
    }

    .tier-pill.active {
      background: #facc15;
      border-color: #facc15;
      color: #111827;
      font-weight: 700;
    }

    .tier-detail {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .token-summary {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.8rem;
    }

    .token-balance {
      font-size: 1rem;
      font-weight: 600;
      color: #a5b4fc;
    }

    .token-earned {
      color: #22c55e;
    }

    .pool-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .pool-card {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      font-size: 0.75rem;
      background: #020617;
    }

    .pool-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .pool-stat {
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .pool-input-row {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .pool-input-row input {
      flex: 1;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
    }

    .pool-input-row button {
      padding: 4px 6px;
      font-size: 0.7rem;
    }

    .leaderboard-list {
      margin-top: 6px;
      font-size: 0.75rem;
    }

    .leader-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #111827;
    }

    .leader-row.me {
      color: #facc15;
    }

    .leader-row:last-child {
      border-bottom: none;
    }

    .tag-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 0.68rem;
      color: #9ca3af;
    }

    .small-label {
      font-size: 0.72rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .input-small {
      width: 100%;
      padding: 5px 8px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.78rem;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">WIN THE DAY</div>
      <div class="app-subtitle">Discipline • Efficiency • Friendly Competition</div>
      <div class="date" id="todayDate"></div>
    </header>

    <!-- LEFT COLUMN: Goals & Discipline -->
    <div>
      <div class="card summary-card">
        <div class="card-header">
          <div>
            <div class="card-title" id="summaryTitle">You haven't won the day yet.</div>
            <div class="card-subtitle" id="summarySubtitle"></div>
          </div>
          <div class="summary-pill not-won" id="summaryPill">In Progress</div>
        </div>
        <div class="summary-body" id="summaryBody"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Today's Goals</div>
          <div class="card-subtitle">Tap to complete and win the day.</div>
        </div>
        <div class="goals-list" id="goalsList"></div>

        <div class="controls-row">
          <button class="btn-primary" id="markAllDone">Mark All Done</button>
          <button class="btn-secondary" id="resetDay">Reset Today</button>
        </div>

        <div class="note">
          Your data is stored locally on this device in this version. Multi-user competition and real money
          pools require a backend & payment integration.
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Streaks</div>
          <div class="card-subtitle">Stack wins over time.</div>
        </div>
        <div class="streak-row">
          <div>
            Current Win Streak<br/>
            <span class="streak-number" id="currentStreak">0</span> days
          </div>
          <div style="text-align:right;">
            Longest Win Streak<br/>
            <span class="streak-number" id="longestStreak">0</span> days
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Customize Your 3 Goals</div>
          <div class="card-subtitle">Mind • Body • Wealth (or your own mix)</div>
        </div>
        <div id="goalSettings"></div>
        <div class="controls-row" style="margin-top:10px;">
          <button class="btn-primary" id="saveGoalSettings">Save Goals</button>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Tiers, Tokens, Pools, Leaderboard -->
    <div>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Subscription Tier (Simulated)</div>
            <div class="card-subtitle">Controls reward multipliers & perks.</div>
          </div>
        </div>
        <div class="tier-options" id="tierOptions">
          <div class="tier-pill" data-tier="free">Free</div>
          <div class="tier-pill" data-tier="pro">Pro</div>
          <div class="tier-pill" data-tier="elite">Elite</div>
        </div>
        <div class="tier-detail" id="tierDetail"></div>
        <div class="note">
          In this MVP, tiers are simulated. In production you'll connect this to Stripe (or similar) and store
          the user’s tier in a database.
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Win Tokens & Rewards</div>
          <div class="card-subtitle">Earn tokens from discipline, use them in pools.</div>
        </div>
        <div class="token-summary">
          <div>
            Token Balance<br/>
            <span class="token-balance" id="tokenBalance">0</span>
          </div>
          <div style="text-align:right;">
            Earned Today<br/>
            <span class="token-earned" id="tokensEarnedToday">+0</span>
          </div>
        </div>
        <div class="small-label" style="margin-top:6px;">
          Earn rates (before multiplier):
        </div>
        <ul style="font-size:0.75rem; margin-left:16px; margin-top:3px; color:#9ca3af;">
          <li>Win the Day: +10 tokens</li>
          <li>Win the Week (5+ days): +50 tokens</li>
          <li>Win the Month (20+ days): +300 tokens</li>
        </ul>
        <div class="note">
          Multipliers by tier – Free: 1x • Pro: 1.5x • Elite: 2x
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Token Pools (Simulated)</div>
          <div class="card-subtitle">Stake tokens in day/week/month/year pools.</div>
        </div>
        <div class="pool-grid" id="poolGrid">
          <!-- Filled by JS -->
        </div>
        <div class="note">
          This MVP simulates pools with tokens only. For real pooled money and multi-user competition,
          you will connect these actions to a backend and payment processor.
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Discipline Leaderboard (Sample)</div>
          <div class="card-subtitle">See how you stack up against a sample cohort.</div>
        </div>
        <div class="leaderboard-list" id="leaderboardList"></div>
        <div class="note">
          This leaderboard is local & demo-only for now. A real leaderboard will pull from your database
          (e.g., Firebase/Supabase) across all users in a similar goal category.
        </div>
      </div>
    </div>
  </div>

  <script>
    // --------- STATE & CONFIG ---------

    const STORAGE_KEY = "winTheDay_v4";

    const DEFAULT_GOALS = [
      {
        id: "goal1",
        label: "5 minutes of Duolingo",
        description: "Intentional language practice.",
        tag: "Mind"
      },
      {
        id: "goal2",
        label: "100 pushups / 100 sit-ups / 100 squats",
        description: "Break it up however you want.",
        tag: "Body"
      },
      {
        id: "goal3",
        label: "Market research + check investment accounts",
        description: "Scan the markets & review your portfolio.",
        tag: "Wealth"
      }
    ];

    const TIER_CONFIG = {
      free: {
        label: "Free",
        multiplier: 1,
        description:
          "Perfect for getting started. Earn tokens at 1x rate. Participate in local pools & build discipline."
      },
      pro: {
        label: "Pro",
        multiplier: 1.5,
        description:
          "For serious builders. Earn tokens 1.5x faster. Designed for weekly & monthly competition."
      },
      elite: {
        label: "Elite",
        multiplier: 2,
        description:
          "For top performers. Earn tokens at 2x. Built for year-long challenges & larger pools (future)."
      }
    };

    const POOL_CONFIG = {
      day: { label: "Daily Pool", key: "day" },
      week: { label: "Weekly Pool", key: "week" },
      month: { label: "Monthly Pool", key: "month" },
      year: { label: "Yearly Pool", key: "year" }
    };

    let state = {
      date: null,          // "YYYY-MM-DD"
      goals: [],           // {id, label, description, tag, completed}
      currentStreak: 0,
      longestStreak: 0,
      totalDaysWonThisWeek: 0,
      totalDaysWonThisMonth: 0,
      tokensBalance: 0,
      tokensEarnedToday: 0,
      tier: "free",
      pools: {
        day: { staked: 0, joined: false, settledForDate: null },
        week: { staked: 0, joined: false, settledForWeek: null },
        month: { staked: 0, joined: false, settledForMonth: null },
        year: { staked: 0, joined: false, settledForYear: null }
      },
      lastWinDate: null
    };

    // --------- UTILITIES ---------

    function getTodayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function getWeekKey(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay(); // 0-6, Sunday = 0
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday as start
      const monday = new Date(d.setDate(diff));
      const y = monday.getFullYear();
      const m = String(monday.getMonth() + 1).padStart(2, "0");
      const dayStr = String(monday.getDate()).padStart(2, "0");
      return `${y}-W${m}${dayStr}`;
    }

    function getMonthKey(date = new Date()) {
      const d = new Date(date);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    function getYearKey(date = new Date()) {
      const d = new Date(date);
      return String(d.getFullYear());
    }

    function formatDate(date) {
      return date.toLocaleDateString(undefined, {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          state = Object.assign(state, parsed);
        } catch (e) {
          console.error("Failed to parse stored state", e);
        }
      }

      // Ensure goals schema
      if (!Array.isArray(state.goals) || state.goals.length === 0) {
        state.goals = DEFAULT_GOALS.map(g => ({
          ...g,
          completed: false
        }));
      } else {
        // Remap any old goals
        state.goals = state.goals.map((g, idx) => {
          const fallback = DEFAULT_GOALS[idx] || {};
          return {
            id: g.id || fallback.id || `goal${idx + 1}`,
            label: g.label || fallback.label || `Goal ${idx + 1}`,
            description: g.description || fallback.description || "",
            tag: g.tag || fallback.tag || "",
            completed: !!g.completed
          };
        });
      }

      if (!state.pools) {
        state.pools = {
          day: { staked: 0, joined: false, settledForDate: null },
          week: { staked: 0, joined: false, settledForWeek: null },
          month: { staked: 0, joined: false, settledForMonth: null },
          year: { staked: 0, joined: false, settledForYear: null }
        };
      }

      if (!state.tier) state.tier = "free";
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function allGoalsCompleted() {
      return state.goals.length > 0 && state.goals.every(g => g.completed);
    }

    function initForToday() {
      const today = getTodayKey();

      if (!state.date || state.date !== today) {
        // If yesterday was a win, update streaks
        if (state.date && state.date !== today && allGoalsCompleted()) {
          updateStreaksOnNewDay(state.date);
        }

        state.date = today;
        state.tokensEarnedToday = 0;
        state.goals = state.goals.map(g => ({ ...g, completed: false }));
      }
    }

    function updateStreaksOnNewDay(previousDateKey) {
      // Compare previous win date for streaks
      const prev = state.lastWinDate;
      const prevDate = prev ? new Date(prev) : null;
      const newDate = new Date(previousDateKey);
      if (prevDate) {
        const diffDays = Math.round(
          (newDate - prevDate) / (1000 * 60 * 60 * 24)
        );
        if (diffDays === 1) {
          state.currentStreak += 1;
        } else {
          state.currentStreak = 1;
        }
      } else {
        state.currentStreak = 1;
      }
      state.lastWinDate = previousDateKey;
      if (state.currentStreak > state.longestStreak) {
        state.longestStreak = state.currentStreak;
      }

      // Week & month counters
      state.totalDaysWonThisWeek += 1;
      state.totalDaysWonThisMonth += 1;
    }

    function getTierMultiplier() {
      const tierInfo = TIER_CONFIG[state.tier] || TIER_CONFIG.free;
      return tierInfo.multiplier || 1;
    }

    function awardTokens(baseAmount, reason) {
      const multiplier = getTierMultiplier();
      const earned = Math.round(baseAmount * multiplier);
      state.tokensBalance += earned;
      state.tokensEarnedToday += earned;
      saveState();
      renderTokenSummary();
      console.log(`Awarded ${earned} tokens for ${reason}`);
    }

    // --------- RENDER FUNCTIONS ---------

    function renderDate() {
      document.getElementById("todayDate").textContent = formatDate(new Date());
    }

    function renderSummary() {
      const titleEl = document.getElementById("summaryTitle");
      const subtitleEl = document.getElementById("summarySubtitle");
      const pillEl = document.getElementById("summaryPill");
      const bodyEl = document.getElementById("summaryBody");

      const completedCount = state.goals.filter(g => g.completed).length;
      const total = state.goals.length;

      if (completedCount === total && total > 0) {
        titleEl.textContent = "You won the day.";
        subtitleEl.textContent = "All of your goals are complete.";
        pillEl.textContent = "Won";
        pillEl.classList.remove("not-won");
        pillEl.classList.add("won");
        bodyEl.textContent =
          "Lock this in and stack another day. Your discipline is compounding.";
      } else {
        titleEl.textContent = "You haven't won the day yet.";
        subtitleEl.textContent = `You've completed ${completedCount} of ${total} goals. Stay locked in.`;
        pillEl.textContent = "In Progress";
        pillEl.classList.remove("won");
        pillEl.classList.add("not-won");
        bodyEl.textContent =
          "Complete all 3 to win the day, earn tokens, and climb your discipline leaderboard.";
      }
    }

    function renderGoals() {
      const container = document.getElementById("goalsList");
      container.innerHTML = "";
      state.goals.forEach(goal => {
        const card = document.createElement("div");
        card.className = "goal-card" + (goal.completed ? " completed" : "");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "goal-checkbox";
        checkbox.checked = goal.completed;
        checkbox.addEventListener("change", () => {
          toggleGoal(goal.id, checkbox.checked);
        });

        const content = document.createElement("div");
        content.className = "goal-content";

        const label = document.createElement("div");
        label.className = "goal-label";
        label.textContent = goal.label;

        const desc = document.createElement("div");
        desc.className = "goal-description";
        desc.textContent = goal.description || "";

        const tag = document.createElement("div");
        tag.className = "goal-tag";
        tag.textContent = goal.tag || "";

        content.appendChild(label);
        if (goal.description) content.appendChild(desc);
        if (goal.tag) content.appendChild(tag);

        card.appendChild(checkbox);
        card.appendChild(content);
        container.appendChild(card);
      });
    }

    function renderStreaks() {
      document.getElementById("currentStreak").textContent =
        state.currentStreak || 0;
      document.getElementById("longestStreak").textContent =
        state.longestStreak || 0;
    }

    function renderGoalSettings() {
      const container = document.getElementById("goalSettings");
      container.innerHTML = "";

      state.goals.forEach((goal, idx) => {
        const wrapper = document.createElement("div");
        wrapper.className = "card";
        wrapper.style.marginBottom = "6px";
        wrapper.style.padding = "8px 10px";

        const title = document.createElement("div");
        title.className = "card-title";
        title.style.fontSize = "0.85rem";
        title.textContent = `Goal ${idx + 1}`;

        const labelLabel = document.createElement("div");
        labelLabel.className = "small-label";
        labelLabel.textContent = "Title";

        const labelInput = document.createElement("input");
        labelInput.className = "input-small";
        labelInput.value = goal.label;

        const descLabel = document.createElement("div");
        descLabel.className = "small-label";
        descLabel.textContent = "Description (optional)";

        const descInput = document.createElement("input");
        descInput.className = "input-small";
        descInput.value = goal.description || "";

        const tagLabel = document.createElement("div");
        tagLabel.className = "small-label";
        tagLabel.textContent = "Category / Tag (Mind, Body, Wealth, etc.)";

        const tagInput = document.createElement("input");
        tagInput.className = "input-small";
        tagInput.value = goal.tag || "";

        wrapper.appendChild(title);
        wrapper.appendChild(labelLabel);
        wrapper.appendChild(labelInput);
        wrapper.appendChild(descLabel);
        wrapper.appendChild(descInput);
        wrapper.appendChild(tagLabel);
        wrapper.appendChild(tagInput);

        // Store for save
        wrapper._labelInput = labelInput;
        wrapper._descInput = descInput;
        wrapper._tagInput = tagInput;

        container.appendChild(wrapper);
      });
    }

    function renderTier() {
      const options = document.querySelectorAll(".tier-pill");
      options.forEach(opt => {
        const t = opt.getAttribute("data-tier");
        if (t === state.tier) {
          opt.classList.add("active");
        } else {
          opt.classList.remove("active");
        }
      });

      const tierInfo = TIER_CONFIG[state.tier] || TIER_CONFIG.free;
      const detailEl = document.getElementById("tierDetail");
      detailEl.textContent =
        `${tierInfo.label} tier • Reward multiplier: ${tierInfo.multiplier}x. ` +
        tierInfo.description;
    }

    function renderTokenSummary() {
      document.getElementById("tokenBalance").textContent =
        state.tokensBalance || 0;
      document.getElementById("tokensEarnedToday").textContent =
        "+" + (state.tokensEarnedToday || 0);
    }

    function renderPools() {
      const grid = document.getElementById("poolGrid");
      grid.innerHTML = "";

      const todayKey = getTodayKey();
      const weekKey = getWeekKey();
      const monthKey = getMonthKey();
      const yearKey = getYearKey();

      const keys = {
        day: todayKey,
        week: weekKey,
        month: monthKey,
        year: yearKey
      };

      Object.keys(POOL_CONFIG).forEach(poolKey => {
        const config = POOL_CONFIG[poolKey];
        const poolState = state.pools[poolKey] || {
          staked: 0,
          joined: false
        };

        const card = document.createElement("div");
        card.className = "pool-card";

        const title = document.createElement("div");
        title.className = "pool-title";
        title.textContent = config.label;

        const keyDisplay = document.createElement("div");
        keyDisplay.className = "pool-stat";
        keyDisplay.textContent = `Period: ${keys[poolKey]}`;

        const staked = document.createElement("div");
        staked.className = "pool-stat";
        staked.textContent = `Your stake: ${poolState.staked || 0} tokens`;

        const status = document.createElement("div");
        status.className = "pool-stat";
        status.textContent = poolState.joined
          ? "Status: Joined"
          : "Status: Not joined";

        const inputRow = document.createElement("div");
        inputRow.className = "pool-input-row";

        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.placeholder = "Tokens";
        inputRow.appendChild(input);

        const btn = document.createElement("button");
        btn.className = "btn-secondary";
        btn.textContent = "Stake";
        btn.addEventListener("click", () => {
          const amount = parseInt(input.value, 10);
          if (isNaN(amount) || amount <= 0) {
            alert("Enter a positive token amount.");
            return;
          }
          joinPool(poolKey, amount);
        });
        inputRow.appendChild(btn);

        card.appendChild(title);
        card.appendChild(keyDisplay);
        card.appendChild(staked);
        card.appendChild(status);
        card.appendChild(inputRow);

        grid.appendChild(card);
      });
    }

    function renderLeaderboard() {
      const list = document.getElementById("leaderboardList");
      list.innerHTML = "";

      // Demo leaderboard data — in a real app this comes from your backend.
      const myScore = state.currentStreak + state.tokensBalance / 50;
      const demoUsers = [
        { name: "Discipline Dave", score: 22.5 },
        { name: "Consistent Carla", score: 18.0 },
        { name: "Steady Sam", score: 12.0 }
      ];

      const fullList = [
        ...demoUsers,
        { name: "You", score: myScore }
      ].sort((a, b) => b.score - a.score);

      fullList.forEach(user => {
        const row = document.createElement("div");
        row.className = "leader-row" + (user.name === "You" ? " me" : "");
        const left = document.createElement("div");
        left.textContent = user.name;
        const right = document.createElement("div");
        right.textContent = user.score.toFixed(1);
        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });
    }

    function renderAll() {
      renderDate();
      renderSummary();
      renderGoals();
      renderStreaks();
      renderGoalSettings();
      renderTier();
      renderTokenSummary();
      renderPools();
      renderLeaderboard();
    }

    // --------- ACTION HANDLERS ---------

    function toggleGoal(goalId, completed) {
      const goal = state.goals.find(g => g.id === goalId);
      if (goal) {
        goal.completed = completed;
      }
      saveState();
      renderSummary();
    }

    function markAllDone() {
      state.goals.forEach(g => (g.completed = true));
      saveState();
      renderSummary();
      renderGoals();
    }

    function resetToday() {
      state.goals.forEach(g => (g.completed = false));
      state.tokensEarnedToday = 0;
      saveState();
      renderAll();
    }

    function saveGoalSettingsFromUI() {
      const container = document.getElementById("goalSettings");
      const wrappers = container.querySelectorAll(".card");
      const newGoals = [];
      wrappers.forEach((wrapper, idx) => {
        const label = wrapper._labelInput.value.trim() || `Goal ${idx + 1}`;
        const description = wrapper._descInput.value.trim();
        const tag = wrapper._tagInput.value.trim();
        const old = state.goals[idx] || {};
        newGoals.push({
          id: old.id || `goal${idx + 1}`,
          label,
          description,
          tag,
          completed: false
        });
      });
      state.goals = newGoals;
      saveState();
      renderGoals();
      renderGoalSettings();
      alert("Goals updated.");
    }

    function setTier(tier) {
      if (!TIER_CONFIG[tier]) return;
      state.tier = tier;
      saveState();
      renderTier();
      renderTokenSummary();
    }

    function handleWinLogic() {
      // Called when we detect that all goals are completed for today
      const today = getTodayKey();
      if (state.lastWinDate === today) {
        // Already processed today's win
        return;
      }

      // Award tokens for daily win
      awardTokens(10, "Win the Day");
      updateStreaksOnNewDay(today);
      state.lastWinDate = today;
      saveState();
      renderStreaks();

      // Weekly / monthly thresholds
      // Very light logic: if 5+ days won in "this week" -> award weekly bonus once,
      // if 20+ days in "this month" -> award monthly bonus once.
      // For full precision you'll want weekKey/monthKey tracking in a backend.
      if (state.totalDaysWonThisWeek === 5) {
        awardTokens(50, "Win the Week");
      }
      if (state.totalDaysWonThisMonth === 20) {
        awardTokens(300, "Win the Month");
      }

      renderSummary();
      renderTokenSummary();
      renderLeaderboard();
    }

    function joinPool(poolKey, amount) {
      if (!POOL_CONFIG[poolKey]) return;
      if (state.tokensBalance < amount) {
        alert("Not enough tokens to stake.");
        return;
      }

      // Deduct tokens and add to pool
      state.tokensBalance -= amount;
      state.tokensEarnedToday -= amount; // purely visual; subtract from today's net
      if (!state.pools[poolKey]) {
        state.pools[poolKey] = { staked: 0, joined: false };
      }
      state.pools[poolKey].staked += amount;
      state.pools[poolKey].joined = true;

      saveState();
      renderTokenSummary();
      renderPools();
    }

    // --------- INIT ---------

    function init() {
      loadState();
      initForToday();
      saveState();
      renderAll();

      document
        .getElementById("markAllDone")
        .addEventListener("click", () => {
          markAllDone();
          if (allGoalsCompleted()) {
            handleWinLogic();
          }
        });

      document
        .getElementById("resetDay")
        .addEventListener("click", resetToday);

      document
        .getElementById("saveGoalSettings")
        .addEventListener("click", saveGoalSettingsFromUI);

      document.querySelectorAll(".tier-pill").forEach(el => {
        el.addEventListener("click", () => {
          const tier = el.getAttribute("data-tier");
          setTier(tier);
        });
      });

      // If user manually completes checkboxes one by one:
      // watch for completion and then apply win logic.
      document.getElementById("goalsList").addEventListener("change", () => {
        if (allGoalsCompleted()) {
          handleWinLogic();
        } else {
          renderSummary();
        }
      });
    }

    init();
  </script>
</body>
</html>
